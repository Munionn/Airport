# Схема базы данных системы управления аэропортом

## Обзор

База данных системы управления аэропортом предназначена для управления всеми аспектами работы аэропорта, включая рейсы, пассажиров, самолеты, экипаж, багаж и техническое обслуживание.

## Структура базы данных

### Основные сущности

#### 1. Users (Пользователи)
Основная таблица пользователей системы (сотрудники аэропорта, пилоты, бортпроводники, техники).

**Поля:**
- `user_id` - Уникальный идентификатор пользователя (PRIMARY KEY)
- `username` - Имя пользователя (UNIQUE)
- `email` - Электронная почта (UNIQUE)
- `password_hash` - Хеш пароля
- `first_name` - Имя
- `last_name` - Фамилия
- `phone` - Номер телефона
- `date_of_birth` - Дата рождения
- `passport_number` - Номер паспорта (UNIQUE)
- `created_at` - Дата создания записи
- `updated_at` - Дата последнего обновления
- `is_active` - Статус активности

#### 2. Roles (Роли)
Роли пользователей в системе (администратор, менеджер, пилот, бортпроводник и т.д.).

**Поля:**
- `role_id` - Уникальный идентификатор роли (PRIMARY KEY)
- `role_name` - Название роли (UNIQUE)
- `description` - Описание роли
- `permissions` - Права доступа (JSON)
- `created_at` - Дата создания

#### 3. User_Roles (Пользовательские роли)
Связь пользователей с их ролями (многие ко многим).

**Поля:**
- `user_role_id` - Уникальный идентификатор (PRIMARY KEY)
- `user_id` - Ссылка на пользователя (FOREIGN KEY)
- `role_id` - Ссылка на роль (FOREIGN KEY)
- `assigned_at` - Дата назначения роли
- `assigned_by` - Кто назначил роль (FOREIGN KEY)

#### 4. Aircraft_Models (Модели самолетов)
Справочник моделей самолетов.

**Поля:**
- `model_id` - Уникальный идентификатор модели (PRIMARY KEY)
- `model_name` - Название модели
- `manufacturer` - Производитель
- `capacity` - Вместимость пассажиров
- `max_range` - Максимальная дальность полета

#### 5. Aircraft (Самолеты)
Информация о конкретных самолетах.

**Поля:**
- `aircraft_id` - Уникальный идентификатор самолета (PRIMARY KEY)
- `registration_number` - Регистрационный номер (UNIQUE)
- `model_id` - Ссылка на модель (FOREIGN KEY)
- `model_name` - Название модели (денормализация)
- `manufacturer` - Производитель (денормализация)
- `capacity` - Вместимость (денормализация)
- `max_range` - Максимальная дальность (денормализация)
- `status` - Статус самолета (active, maintenance, retired)
- `purchase_date` - Дата покупки
- `last_maintenance` - Дата последнего обслуживания
- `next_maintenance` - Дата следующего обслуживания

#### 6. Cities (Города)
Справочник городов и стран.

**Поля:**
- `city_id` - Уникальный идентификатор города (PRIMARY KEY)
- `city_name` - Название города
- `country` - Страна
- `timezone` - Часовой пояс

#### 7. Airports (Аэропорты)
Информация об аэропортах.

**Поля:**
- `airport_id` - Уникальный идентификатор аэропорта (PRIMARY KEY)
- `iata_code` - Код IATA (UNIQUE)
- `icao_code` - Код ICAO (UNIQUE)
- `airport_name` - Название аэропорта
- `city_id` - Ссылка на город (FOREIGN KEY)
- `latitude` - Широта
- `longitude` - Долгота

#### 8. Routes (Маршруты)
Маршруты между аэропортами.

**Поля:**
- `route_id` - Уникальный идентификатор маршрута (PRIMARY KEY)
- `route_name` - Название маршрута
- `departure_airport_id` - Аэропорт отправления (FOREIGN KEY)
- `arrival_airport_id` - Аэропорт прибытия (FOREIGN KEY)
- `distance` - Расстояние в километрах
- `duration` - Продолжительность полета
- `status` - Статус маршрута (active, inactive)

#### 9. Terminals (Терминалы)
Терминалы аэропорта.

**Поля:**
- `terminal_id` - Уникальный идентификатор терминала (PRIMARY KEY)
- `terminal_name` - Название терминала
- `terminal_code` - Код терминала (UNIQUE)
- `capacity` - Вместимость терминала
- `status` - Статус терминала (active, maintenance, closed)
- `opening_hours` - Часы работы

#### 10. Gates (Гейты)
Гейты в терминалах.

**Поля:**
- `gate_id` - Уникальный идентификатор гейта (PRIMARY KEY)
- `terminal_id` - Ссылка на терминал (FOREIGN KEY)
- `gate_number` - Номер гейта
- `status` - Статус гейта (available, occupied, maintenance)
- `capacity` - Вместимость гейта

#### 11. Flights (Рейсы)
Информация о рейсах.

**Поля:**
- `flight_id` - Уникальный идентификатор рейса (PRIMARY KEY)
- `flight_number` - Номер рейса (UNIQUE)
- `aircraft_id` - Ссылка на самолет (FOREIGN KEY)
- `route_id` - Ссылка на маршрут (FOREIGN KEY)
- `departure_airport_id` - Аэропорт отправления (FOREIGN KEY, денормализация)
- `arrival_airport_id` - Аэропорт прибытия (FOREIGN KEY, денормализация)
- `gate_id` - Ссылка на гейт (FOREIGN KEY)
- `scheduled_departure` - Плановое время отправления
- `scheduled_arrival` - Плановое время прибытия
- `actual_departure` - Фактическое время отправления
- `actual_arrival` - Фактическое время прибытия
- `status` - Статус рейса (scheduled, boarding, departed, arrived, cancelled, delayed)
- `price` - Цена билета

#### 12. Passengers (Пассажиры)
Информация о пассажирах.

**Поля:**
- `passenger_id` - Уникальный идентификатор пассажира (PRIMARY KEY)
- `user_id` - Ссылка на пользователя (FOREIGN KEY, опционально)
- `first_name` - Имя
- `last_name` - Фамилия
- `passport_number` - Номер паспорта
- `nationality` - Национальность
- `date_of_birth` - Дата рождения
- `phone` - Номер телефона
- `email` - Электронная почта
- `special_requirements` - Особые требования
- `created_at` - Дата создания записи

#### 13. Tickets (Билеты)
Билеты пассажиров на рейсы.

**Поля:**
- `ticket_id` - Уникальный идентификатор билета (PRIMARY KEY)
- `ticket_number` - Номер билета (UNIQUE)
- `flight_id` - Ссылка на рейс (FOREIGN KEY)
- `passenger_id` - Ссылка на пассажира (FOREIGN KEY)
- `seat_number` - Номер места
- `class` - Класс обслуживания (economy, business, first)
- `price` - Цена билета
- `status` - Статус билета (active, cancelled, used, refunded)
- `purchase_date` - Дата покупки
- `check_in_time` - Время регистрации

#### 14. Baggage (Багаж)
Багаж пассажиров.

**Поля:**
- `baggage_id` - Уникальный идентификатор багажа (PRIMARY KEY)
- `passenger_id` - Ссылка на пассажира (FOREIGN KEY)
- `flight_id` - Ссылка на рейс (FOREIGN KEY)
- `baggage_tag` - Тег багажа (UNIQUE)
- `weight` - Вес багажа
- `status` - Статус багажа (checked_in, loaded, unloaded, delivered, lost)
- `check_in_time` - Время регистрации багажа
- `delivery_time` - Время доставки багажа

#### 15. Flight_Crew (Экипаж рейса)
Назначение экипажа на рейсы.

**Поля:**
- `crew_id` - Уникальный идентификатор назначения (PRIMARY KEY)
- `flight_id` - Ссылка на рейс (FOREIGN KEY)
- `user_id` - Ссылка на пользователя (FOREIGN KEY)
- `position` - Должность (pilot, co_pilot, flight_engineer, flight_attendant, purser)
- `assigned_at` - Дата назначения

#### 16. Maintenance_Records (Записи технического обслуживания)
Записи о техническом обслуживании самолетов.

**Поля:**
- `maintenance_id` - Уникальный идентификатор записи (PRIMARY KEY)
- `aircraft_id` - Ссылка на самолет (FOREIGN KEY)
- `maintenance_type` - Тип обслуживания (routine, repair, inspection, overhaul)
- `description` - Описание работ
- `start_date` - Дата начала работ
- `end_date` - Дата окончания работ
- `cost` - Стоимость работ
- `technician_id` - Ссылка на техника (FOREIGN KEY)
- `status` - Статус работ (scheduled, in_progress, completed, cancelled)

#### 17. Audit_Logs (Журнал аудита)
Журнал действий пользователей в системе.

**Поля:**
- `log_id` - Уникальный идентификатор записи (PRIMARY KEY)
- `user_id` - Ссылка на пользователя (FOREIGN KEY)
- `action` - Действие (INSERT, UPDATE, DELETE)
- `table_name` - Название таблицы
- `record_id` - ID записи
- `old_values` - Старые значения (JSON)
- `new_values` - Новые значения (JSON)
- `ip_address` - IP адрес
- `user_agent` - User Agent
- `timestamp` - Время действия

## Связи между таблицами

### Основные связи:

1. **Users ↔ Roles** (многие ко многим через User_Roles)
2. **Aircraft_Models → Aircraft** (один ко многим)
3. **Cities → Airports** (один ко многим)
4. **Airports → Routes** (один ко многим, отправление и прибытие)
5. **Routes → Flights** (один ко многим)
6. **Aircraft → Flights** (один ко многим)
7. **Terminals → Gates** (один ко многим)
8. **Gates → Flights** (один ко многим)
9. **Users → Passengers** (один ко многим, опционально)
10. **Passengers → Tickets** (один ко многим)
11. **Flights → Tickets** (один ко многим)
12. **Passengers → Baggage** (один ко многим)
13. **Flights → Baggage** (один ко многим)
14. **Users → Flight_Crew** (один ко многим)
15. **Flights → Flight_Crew** (один ко многим)
16. **Aircraft → Maintenance_Records** (один ко многим)
17. **Users → Maintenance_Records** (один ко многим, техники)
18. **Users → Audit_Logs** (один ко многим)

## Индексы

### Основные индексы:
- Индексы по первичным ключам (автоматически)
- Индексы по внешним ключам
- Индексы по уникальным полям
- Составные индексы для оптимизации запросов

### Специальные индексы:
- Индексы по датам для временных запросов
- Индексы по статусам для фильтрации
- Индексы по географическим координатам

## Ограничения

### Проверочные ограничения (CHECK):
- Формат email адресов
- Формат телефонных номеров
- Формат номеров паспортов
- Возраст пассажиров (не менее 0 лет)
- Координаты аэропортов (широта: -90 до 90, долгота: -180 до 180)
- Положительные значения для веса, цены, расстояния
- Валидные статусы для всех ENUM полей

### Уникальные ограничения:
- Уникальные комбинации полей (например, модель + производитель)
- Уникальные номера рейсов, билетов, багажа
- Уникальные коды аэропортов (IATA, ICAO)

### Внешние ключи:
- Каскадное удаление для зависимых записей
- Ограничение удаления для справочных данных
- Установка NULL для опциональных связей

## Триггеры

### Автоматические триггеры:
1. **Обновление временных меток** - автоматическое обновление `updated_at`
2. **Синхронизация денормализованных данных** - обновление данных самолета при изменении модели
3. **Аудит изменений** - автоматическое логирование изменений в критических таблицах

## Представления (Views)

### Основные представления:
1. **flight_details** - детальная информация о рейсах с аэропортами и самолетами
2. **flight_statistics** - статистика рейсов по дням
3. **passenger_ticket_info** - информация о пассажирах с их билетами

## Функции

### Пользовательские функции:
1. **check_seat_availability()** - проверка доступности места
2. **calculate_flight_load()** - расчет загрузки рейса
3. **search_flights()** - поиск рейсов по маршруту и дате

## Права доступа

### Роли:
1. **airport_admin** - полные права администратора
2. **airport_reader** - права только на чтение
3. **airport_operator** - права на чтение, вставку и обновление

## Особенности реализации

### Денормализация:
- Характеристики самолета денормализованы для быстрого доступа
- Аэропорты отправления и прибытия денормализованы в таблице Flights

### Производительность:
- Индексы оптимизированы для типичных запросов
- Составные индексы для сложных операций
- Представления для упрощения запросов

### Целостность данных:
- Триггеры для поддержания консистентности
- Ограничения для валидации данных
- Аудит для отслеживания изменений

## Статистика

### Количество таблиц: 17
### Количество индексов: 25+
### Количество триггеров: 8
### Количество представлений: 3
### Количество функций: 3

## Заключение

База данных системы управления аэропортом представляет собой комплексную систему, охватывающую все аспекты работы аэропорта. Схема спроектирована с учетом требований производительности, целостности данных и масштабируемости.

Основные принципы проектирования:
- Нормализация до 3НФ с обоснованной денормализацией
- Полная ссылочная целостность
- Автоматический аудит изменений
- Оптимизация для типичных операций
- Поддержка европейских данных и маршрутов
